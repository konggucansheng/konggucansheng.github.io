I"í<p>è¿™å‘¨æ”¶åˆ°ä¸€ä¸ª sentry æŠ¥è­¦ï¼Œå¦‚ä¸‹ SQL æŸ¥è¯¢è¶…æ—¶äº†ã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select * from order_info where uid = 5837661 order by id asc limit 1
</code></pre></div></div>
<p>æ‰§è¡Œshow create table order_info å‘ç°è¿™ä¸ªè¡¨å…¶å®æ˜¯æœ‰åŠ ç´¢å¼•çš„</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE TABLE `order_info` (
 Â `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
 Â `uid` int(11) unsigned,
 Â `order_status` tinyint(3) DEFAULT NULL,
  ... çœç•¥å…¶å®ƒå­—æ®µå’Œç´¢å¼•
 Â PRIMARY KEY (`id`),
 Â KEY `idx_uid_stat` (`uid`,`order_status`),
) ENGINE=InnoDB DEFAULT CHARSET=utf8
</code></pre></div></div>
<p>ç†è®ºä¸Šæ‰§è¡Œä¸Šè¿° SQL ä¼šå‘½ä¸­ idx_uid_stat è¿™ä¸ªç´¢å¼•ï¼Œä½†å®é™…æ‰§è¡Œ explain æŸ¥çœ‹</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>explain select * from order_info where uid = 5837661 order by id asc limit 1
</code></pre></div></div>
<p>å¯ä»¥çœ‹åˆ°å®ƒçš„ possible_keysï¼ˆæ­¤ SQL å¯èƒ½æ¶‰åŠåˆ°çš„ç´¢å¼•ï¼‰ æ˜¯ idx_uid_statï¼Œä½†å®é™…ä¸Šï¼ˆkeyï¼‰ç”¨çš„å´æ˜¯å…¨è¡¨æ‰«æ</p>

<p>æˆ‘ä»¬çŸ¥é“ MySQL æ˜¯åŸºäºæˆæœ¬æ¥é€‰æ‹©æ˜¯åŸºäºå…¨è¡¨æ‰«æè¿˜æ˜¯é€‰æ‹©æŸä¸ªç´¢å¼•æ¥æ‰§è¡Œæœ€ç»ˆçš„æ‰§è¡Œè®¡åˆ’çš„ï¼Œæ‰€ä»¥çœ‹èµ·æ¥æ˜¯å…¨è¡¨æ‰«æçš„æˆæœ¬å°äºåŸºäº idx_uid_stat ç´¢å¼•æ‰§è¡Œçš„æˆæœ¬ï¼Œä¸è¿‡æˆ‘çš„ç¬¬ä¸€æ„Ÿè§‰å¾ˆå¥‡æ€ªï¼Œè¿™æ¡ SQL è™½ç„¶æ˜¯å›è¡¨ï¼Œä½†å®ƒçš„ limit æ˜¯ 1ï¼Œä¹Ÿå°±æ˜¯è¯´åªé€‰æ‹©äº†æ»¡è¶³ uid = 5837661 ä¸­çš„å…¶ä¸­ä¸€æ¡è¯­å¥ï¼Œå°±ç®—å›è¡¨ä¹Ÿåªå›ä¸€æ¡è®°å½•ï¼Œè¿™ç§æˆæœ¬å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œä¼˜åŒ–å™¨æ€ä¹ˆä¼šé€‰æ‹©å…¨è¡¨æ‰«æå‘¢ã€‚
å½“ç„¶æ€€ç–‘å½’æ€€ç–‘ï¼Œä¸ºäº†æŸ¥çœ‹ MySQL ä¼˜åŒ–å™¨ä¸ºå•¥é€‰æ‹©äº†å…¨è¡¨æ‰«æï¼Œæˆ‘æ‰“å¼€äº† optimizer_trace æ¥ä¸€æ¢ç©¶ç«Ÿ
ç”»å¤–éŸ³ï¼šåœ¨MySQL 5.6 åŠä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ optimizer trace åŠŸèƒ½æŸ¥çœ‹ä¼˜åŒ–å™¨ç”Ÿæˆæ‰§è¡Œè®¡åˆ’çš„æ•´ä¸ªè¿‡ç¨‹
ä½¿ç”¨ optimizer_trace çš„å…·ä½“è¿‡ç¨‹å¦‚ä¸‹</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SET optimizer_trace="enabled=on";   // æ‰“å¼€ optimizer_trace
SELECT * FROM order_info where uid = 5837661 order by id asc limit 1
SELECT * FROM information_schema.OPTIMIZER_TRACE; // æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’è¡¨
SET optimizer_trace="enabled=off"; // å…³é—­ optimizer_trace
</code></pre></div></div>
<p>MySQL ä¼˜åŒ–å™¨é¦–å…ˆä¼šè®¡ç®—å‡ºå…¨è¡¨æ‰«æçš„æˆæœ¬ï¼Œç„¶åé€‰å‡ºè¯¥ SQL å¯èƒ½æ¶‰åŠåˆ°åˆ°çš„æ‰€æœ‰ç´¢å¼•å¹¶ä¸”è®¡ç®—ç´¢å¼•çš„æˆæœ¬ï¼Œç„¶åé€‰å‡ºæ‰€æœ‰æˆæœ¬æœ€å°çš„é‚£ä¸ªæ¥æ‰§è¡Œï¼Œæ¥çœ‹ä¸‹ optimizer trace ç»™å‡ºçš„å…³é”®ä¿¡æ¯</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
 Â "rows_estimation": [
 Â   {
 Â  Â  Â "table": "`rebate_order_info`",
 Â  Â  Â "range_analysis": {
 Â  Â  Â  Â "table_scan": {
 Â  Â  Â  Â  Â "rows": 21155996,
 Â  Â  Â  Â  Â "cost": 4.45e6 Â   // å…¨è¡¨æ‰«ææˆæœ¬
 Â  Â  Â   }
 Â  Â   },
 Â  Â   ...
 Â  Â  Â "analyzing_range_alternatives": {
 Â  Â  Â  Â  Â "range_scan_alternatives": [
 Â  Â  Â  Â   {
 Â  Â  Â  Â  Â  Â "index": "idx_uid_stat",
 Â  Â  Â  Â  Â  Â "ranges": [
 Â  Â  Â  Â  Â  Â "5837661 &lt;= uid &lt;= 5837661"
 Â  Â  Â  Â  Â   ],
 Â  Â  Â  Â  Â  Â "index_dives_for_eq_ranges": true,
 Â  Â  Â  Â  Â  Â "rowid_ordered": false,
 Â  Â  Â  Â  Â  Â "using_mrr": false,
 Â  Â  Â  Â  Â  Â "index_only": false,
 Â  Â  Â  Â  Â  Â "rows": 255918,
 Â  Â  Â  Â  Â  Â "cost": 307103,     // ä½¿ç”¨idx_uid_statç´¢å¼•çš„æˆæœ¬
 Â  Â  Â  Â  Â  Â "chosen": true
 Â  Â  Â  Â  Â   }
 Â  Â  Â  Â   ],
 Â  Â  Â  "chosen_range_access_summary": { // ç»è¿‡ä¸Šé¢çš„å„ä¸ªæˆæœ¬æ¯”è¾ƒåé€‰æ‹©çš„æœ€ç»ˆç»“æœ
 Â  Â  Â  Â  "range_access_plan": {
 Â  Â  Â  Â  Â  Â  "type": "range_scan",
 Â  Â  Â  Â  Â  Â  "index": "idx_uid_stat",   // å¯ä»¥çœ‹åˆ°æœ€ç»ˆé€‰æ‹©äº†idx_uid_statè¿™ä¸ªç´¢å¼•æ¥æ‰§è¡Œ
 Â  Â  Â  Â  Â  Â  "rows": 255918,
 Â  Â  Â  Â  Â  Â  "ranges": [
 Â  Â  Â  Â  Â  Â  "58376617 &lt;= uid &lt;= 58376617"
 Â  Â  Â  Â  Â  Â  ]
 Â  Â  Â  Â  },
 Â  Â  Â  Â  "rows_for_plan": 255918,
 Â  Â  Â  Â  "cost_for_plan": 307103,
 Â  Â  Â  Â  "chosen": true
 Â  Â  Â  Â  }
 Â  Â  Â  Â  } Â 
 Â   ...
</code></pre></div></div>
<p>å¯ä»¥çœ‹åˆ°å…¨è¡¨æ‰«æçš„æˆæœ¬æ˜¯ 4.45e6ï¼Œè€Œé€‰æ‹©ç´¢å¼• idx_uid_stat çš„æˆæœ¬æ˜¯ 307103ï¼Œè¿œå°äºå…¨è¡¨æ‰«æçš„æˆæœ¬ï¼Œè€Œä¸”ä»æœ€ç»ˆçš„é€‰æ‹©ç»“æœï¼ˆchosen_range_access_summaryï¼‰æ¥çœ‹ï¼Œç¡®å®ä¹Ÿæ˜¯é€‰æ‹©äº† idx_uid_stat è¿™ä¸ªç´¢å¼•ï¼Œä½†ä¸ºå•¥ä» explain çœ‹åˆ°çš„é€‰æ‹©æ˜¯æ‰§è¡Œ PRIMARY ä¹Ÿå°±æ˜¯å…¨è¡¨æ‰«æå‘¢ï¼Œéš¾é“è¿™ä¸ªæ‰§è¡Œè®¡åˆ’æœ‰è¯¯ï¼Ÿ</p>

<p>ä»”ç»†å†çœ‹äº†ä¸€ä¸‹è¿™ä¸ªæ‰§è¡Œè®¡åˆ’ï¼Œæœç„¶å‘ç°äº†çŒ«è…»ï¼Œæ‰§è¡Œè®¡åˆ’ä¸­æœ‰ä¸€ä¸ª reconsidering_access_paths_for_index_ordering é€‰æ‹©å¼•èµ·äº†æˆ‘çš„æ³¨æ„</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "reconsidering_access_paths_for_index_ordering": {
 Â  Â "clause": "ORDER BY",
 Â  Â "index_order_summary": {
 Â  Â  Â "table": "`rebate_order_info`",
 Â  Â  Â "index_provides_order": true,
 Â  Â  Â "order_direction": "asc",
 Â  Â  Â "index": "PRIMARY", // å¯ä»¥çœ‹åˆ°é€‰æ‹©äº†ä¸»é”®ç´¢å¼•
 Â  Â  Â "plan_changed": true,
 Â  Â  Â "access_type": "index_scan"
    }
  }
}
</code></pre></div></div>
<p>è¿™ä¸ªé€‰æ‹©è¡¨ç¤ºç”±äºæ’åºçš„åŸå› å†è¿›è¡Œäº†ä¸€æ¬¡ç´¢å¼•é€‰æ‹©ä¼˜åŒ–ï¼Œç”±äºæˆ‘ä»¬çš„ SQL ä½¿ç”¨äº† id æ’åºï¼ˆorder by id asc limit 1ï¼‰,ä¼˜åŒ–å™¨æœ€ç»ˆé€‰æ‹©äº† PRIMARY ä¹Ÿå°±æ˜¯å…¨è¡¨æ‰«ææ¥æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªé€‰æ‹©ä¼šæ— è§†ä¹‹å‰çš„åŸºäºç´¢å¼•æˆæœ¬çš„é€‰æ‹©ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·çš„ä¸€ä¸ªé€‰é¡¹å‘¢ï¼Œä¸»è¦åŸå› å¦‚ä¸‹ï¼š</p>

<blockquote>
  <p>The short explanation is that the optimizer thinks â€” or should I say hopes â€” that scanning the whole table (which is already sorted by the id field) will find the limited rows quick enough, and that this will avoid a sort operation. So by trying to avoid a sort, the optimizer ends-up losing time scanning the table.</p>
</blockquote>

<p>ä»è¿™æ®µè§£é‡Šå¯ä»¥çœ‹å‡ºä¸»è¦åŸå› æ˜¯ç”±äºæˆ‘ä»¬ä½¿ç”¨äº† order by id asc è¿™ç§åŸºäº id çš„æ’åºå†™æ³•ï¼Œä¼˜åŒ–å™¨è®¤ä¸ºæ’åºæ˜¯ä¸ªæ˜‚è´µçš„æ“ä½œï¼Œæ‰€ä»¥ä¸ºäº†é¿å…æ’åºï¼Œå¹¶ä¸”å®ƒè®¤ä¸º limit n çš„ n å¦‚æœå¾ˆå°çš„è¯å³ä½¿ä½¿ç”¨å…¨è¡¨æ‰«æä¹Ÿèƒ½å¾ˆå¿«æ‰§è¡Œå®Œï¼Œè¿™æ ·ä½¿ç”¨å…¨è¡¨æ‰«æä¹Ÿå°±é¿å…äº† id çš„æ’åºï¼ˆå…¨è¡¨æ‰«æå…¶å®ä¹Ÿå°±æ˜¯åŸºäº id ä¸»é”®çš„èšç°‡ç´¢å¼•çš„æ‰«æï¼Œæœ¬èº«å°±æ˜¯åŸºäº id æ’å¥½åºçš„ï¼‰
å¦‚æœè¿™ä¸ªé€‰æ‹©æ˜¯å¯¹çš„é‚£ä¹Ÿç½¢äº†ï¼Œç„¶è€Œå®é™…ä¸Šè¿™ä¸ªä¼˜åŒ–å´æ˜¯æœ‰ bug çš„ï¼å®é™…é€‰æ‹© idx_uid_stat æ‰§è¡Œä¼šå¿«å¾—å¤šï¼ˆåªè¦ 28 msï¼‰ï¼ç½‘ä¸Šæœ‰ä¸å°‘äººåé¦ˆè¿™ä¸ªé—®é¢˜ï¼Œè€Œä¸”å‡ºç°è¿™ä¸ªé—®é¢˜åŸºæœ¬åªä¸ SQL ä¸­å‡ºç° order by id asc limit nè¿™ç§å†™æ³•æœ‰å…³ï¼Œå¦‚æœ n æ¯”è¾ƒå°å¾ˆå¤§æ¦‚ç‡ä¼šèµ°å…¨è¡¨æ‰«æï¼Œå¦‚æœ n æ¯”è¾ƒå¤§åˆ™ä¼šé€‰æ‹©æ­£ç¡®çš„ç´¢å¼•ã€‚
è¿™ä¸ª bug æœ€æ—©è¿½æº¯åˆ° 2014 å¹´ï¼Œä¸å°‘äººéƒ½å‘¼åå®˜æ–¹åŠæ—¶ä¿®æ­£è¿™ä¸ªbugï¼Œå¯èƒ½æ˜¯å®ç°æ¯”è¾ƒå›°éš¾ï¼Œç›´åˆ° MySQL 5.7ï¼Œ8.0 éƒ½è¿˜æ²¡è§£å†³ï¼Œæ‰€ä»¥åœ¨å®˜æ–¹ä¿®å¤å‰æˆ‘ä»¬è¦å°½é‡é¿å…è¿™ç§å†™æ³•ï¼Œé‚£ä¹ˆæ€ä¹ˆé¿å…å‘¢ï¼Œä¸»è¦æœ‰ä¸¤ç§æ–¹æ¡ˆ</p>

<p>ä½¿ç”¨ force index æ¥å¼ºåˆ¶ä½¿ç”¨æŒ‡å®šçš„ç´¢å¼•ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select * from order_info force index(idx_uid_stat) where uid = 5837661 order by id asc limit 1
</code></pre></div></div>
<p>è¿™ç§å†™æ³•è™½ç„¶å¯ä»¥ï¼Œä½†ä¸å¤Ÿä¼˜é›…ï¼Œå¦‚æœè¿™ä¸ªç´¢å¼•è¢«åºŸå¼ƒäº†å’‹åŠï¼Ÿäºæ˜¯æœ‰äº†ç¬¬äºŒç§æ¯”è¾ƒä¼˜é›…çš„æ–¹æ¡ˆ</p>

<p>ä½¿ç”¨ order by (id+0) æ–¹æ¡ˆï¼Œå¦‚ä¸‹</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select * from order_info where uid = 5837661 order by (id+0) asc limit 1
</code></pre></div></div>
<p>è¿™ç§æ–¹æ¡ˆä¹Ÿå¯ä»¥è®©ä¼˜åŒ–å™¨é€‰æ‹©æ­£ç¡®çš„ç´¢å¼•ï¼Œæ›´æ¨èï¼
å·¨äººçš„è‚©è†€</p>

<p>mysql ä¼˜åŒ–å™¨ bug <a href="http://4zsw5.cn/L1zEi">4zsw5.cn/L1zEi</a>
<a href="https://juejin.cn/post/7012093121907392519?utm_source=gold_browser_extension">æ–‡ç« æ¥æº</a></p>

:ET