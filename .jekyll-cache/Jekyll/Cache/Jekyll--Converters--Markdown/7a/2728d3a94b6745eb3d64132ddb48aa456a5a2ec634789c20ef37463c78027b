I"ëS<p>åœ¨åç«¯ç›¸å…³å²—ä½çš„å…¥èŒé¢è¯•ä¸­ï¼Œä¸‰æ¬¡æ¡æ‰‹çš„å‡ºåœºé¢‘ç‡éå¸¸çš„é«˜ï¼Œç”šè‡³è¯´å®ƒæ˜¯å¿…è€ƒé¢˜ä¹Ÿä¸ä¸ºè¿‡ã€‚ä¸€èˆ¬çš„ç­”æ¡ˆéƒ½æ˜¯è¯´å®¢æˆ·ç«¯å¦‚ä½•å‘èµ· SYN æ¡æ‰‹è¿›å…¥ SYN_SENT çŠ¶æ€ï¼ŒæœåŠ¡å™¨å“åº” SYN å¹¶å›å¤ SYNACKï¼Œç„¶åè¿›å…¥ SYN_RECVï¼Œâ€¦â€¦ , å§å•¦å§å•¦è¯¸å¦‚æ­¤ç±»ã€‚<br />
ä½†æˆ‘ä»Šå¤©æƒ³ç»™å‡ºä¸€ä»½ä¸ä¸€æ ·çš„ç­”æ¡ˆã€‚å…¶å®ä¸‰æ¬¡æ¡æ‰‹åœ¨å†…æ ¸çš„å®ç°ä¸­ï¼Œå¹¶ä¸åªæ˜¯ç®€å•çš„çŠ¶æ€çš„æµè½¬ï¼Œè¿˜åŒ…æ‹¬åŠè¿æ¥é˜Ÿåˆ—ã€syncookieã€å…¨è¿æ¥é˜Ÿåˆ—ã€é‡ä¼ è®¡æ—¶å™¨ç­‰å…³é”®æ“ä½œã€‚å¦‚æœèƒ½æ·±åˆ»ç†è§£è¿™äº›ï¼Œä½ å¯¹çº¿ä¸ŠæŠŠæ¡å’Œç†è§£å°†æ›´è¿›ä¸€æ­¥ã€‚å¦‚æœæœ‰é¢è¯•å®˜é—®èµ·ä½ ä¸‰æ¬¡æ¡æ‰‹ï¼Œç›¸ä¿¡è¿™ä»½ç­”æ¡ˆä¸€å®šèƒ½å¸®ä½ åœ¨é¢è¯•å®˜é¢å‰èµ¢å¾—éå¸¸å¤šçš„åŠ åˆ†ã€‚<br />
åœ¨åŸºäº TCP çš„æœåŠ¡å¼€å‘ä¸­ï¼Œä¸‰æ¬¡æ¡æ‰‹çš„ä¸»è¦æµç¨‹å›¾å¦‚ä¸‹ã€‚ 
<img src="/assets/images/tcp1.png" width="400" height="400" /><br />
æœåŠ¡å™¨ä¸­çš„æ ¸å¿ƒä»£ç æ˜¯åˆ›å»º socketï¼Œç»‘å®šç«¯å£ï¼Œlisten ç›‘å¬ï¼Œæœ€å accept æ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//æœåŠ¡ç«¯æ ¸å¿ƒä»£ç 
int main(int argc, char const *argv[])
{
 int fd = socket(AF_INET, SOCK_STREAM, 0);
 bind(fd, ...);
 listen(fd, 128);
 accept(fd, ...);
 ...
}
</code></pre></div></div>
<p>å®¢æˆ·ç«¯çš„ç›¸å…³ä»£ç æ˜¯åˆ›å»º socketï¼Œç„¶åè°ƒç”¨ connect è¿æ¥ serverã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//å®¢æˆ·ç«¯æ ¸å¿ƒä»£ç 
int main(){
 fd = socket(AF_INET,SOCK_STREAM, 0);
 connect(fd, ...);
 ...
}
</code></pre></div></div>
<p>å›´ç»•è¿™ä¸ªä¸‰æ¬¡æ¡æ‰‹å›¾ï¼Œä»¥åŠå®¢æˆ·ç«¯ï¼ŒæœåŠ¡ç«¯çš„æ ¸å¿ƒä»£ç ï¼Œæˆ‘ä»¬æ¥æ·±åº¦æ¢ç´¢ä¸€ä¸‹ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ä¸­çš„å†…éƒ¨æ“ä½œã€‚æˆ‘ä»¬ä»å’Œä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹å…³ç³»æ¯”è¾ƒå¤§çš„ listen è®²èµ·ï¼<br />
å‹æƒ…æç¤ºï¼šæœ¬æ–‡ä¸­å†…æ ¸æºç ä¼šæ¯”è¾ƒå¤šã€‚å¦‚æœä½ èƒ½ç†è§£çš„äº†æ›´å¥½ï¼Œå¦‚æœè§‰å¾—ç†è§£èµ·æ¥æœ‰å›°éš¾ï¼Œé‚£ç›´æ¥é‡ç‚¹çœ‹æœ¬æ–‡ä¸­çš„æè¿°æ€§çš„æ–‡å­—ï¼Œå°¤å…¶æ˜¯åŠ ç²—éƒ¨åˆ†çš„å³å¯ã€‚å¦å¤–æ–‡ç« æœ€åæœ‰ä¸€å¼ æ€»ç»“å›¾å½’çº³å’Œæ•´ç†äº†å…¨æ–‡å†…å®¹ã€‚<br />
ä¸€ã€æœåŠ¡å™¨çš„ listen</p>

<p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒæœåŠ¡å™¨åœ¨å¼€å§‹æä¾›æœåŠ¡ä¹‹å‰éƒ½éœ€è¦å…ˆ listen ä¸€ä¸‹ã€‚ä½† listen å†…éƒ¨ç©¶ç«Ÿå¹²äº†å•¥ï¼Œæˆ‘ä»¬å¹³æ—¶å¾ˆå°‘å»ç¢ç£¨ã€‚<br />
ä»Šå¤©å°±è®©æˆ‘ä»¬è¯¦ç»†æ¥çœ‹çœ‹ï¼Œç›´æ¥ä¸Šä¸€æ®µ listen æ—¶æ‰§è¡Œåˆ°çš„å†…æ ¸ä»£ç ã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//file: net/core/request_sock.c
int reqsk_queue_alloc(struct request_sock_queue *queue,
     unsigned int nr_table_entries)
{
 size_t lopt_size = sizeof(struct listen_sock);
 struct listen_sock *lopt;

 //è®¡ç®—åŠè¿æ¥é˜Ÿåˆ—çš„é•¿åº¦
 nr_table_entries = min_t(u32, nr_table_entries, sysctl_max_syn_backlog);
 nr_table_entries = ......

 //ä¸ºåŠè¿æ¥é˜Ÿåˆ—ç”³è¯·å†…å­˜
 lopt_size += nr_table_entries * sizeof(struct request_sock *);
 if (lopt_size &gt; PAGE_SIZE)
  lopt = vzalloc(lopt_size);
 else
  lopt = kzalloc(lopt_size, GFP_KERNEL);

 //å…¨è¿æ¥é˜Ÿåˆ—å¤´åˆå§‹åŒ–
 queue-&gt;rskq_accept_head = NULL;

 //åŠè¿æ¥é˜Ÿåˆ—è®¾ç½®
 lopt-&gt;nr_table_entries = nr_table_entries;
 queue-&gt;listen_opt = lopt;
 ......
}
</code></pre></div></div>
<p>åœ¨è¿™æ®µä»£ç é‡Œï¼Œå†…æ ¸è®¡ç®—äº†åŠè¿æ¥é˜Ÿåˆ—çš„é•¿åº¦ã€‚ç„¶åæ®æ­¤ç®—å‡ºåŠè¿æ¥é˜Ÿåˆ—æ‰€éœ€è¦çš„å®é™…å†…å­˜å¤§å°ï¼Œå¼€å§‹ç”³è¯·ç”¨äºç®¡ç†åŠè¿æ¥é˜Ÿåˆ—å¯¹è±¡çš„å†…å­˜ï¼ˆåŠè¿æ¥é˜Ÿåˆ—éœ€è¦å¿«é€ŸæŸ¥æ‰¾ï¼Œæ‰€ä»¥å†…æ ¸æ˜¯ç”¨å“ˆå¸Œè¡¨æ¥ç®¡ç†åŠè¿æ¥é˜Ÿåˆ—çš„ï¼Œå…·ä½“åœ¨ listen_sock ä¸‹çš„ syn_table ä¸‹ï¼‰ã€‚æœ€åå°†åŠè¿æ¥é˜Ÿåˆ—æŒ‚åˆ°äº†æ¥æ”¶é˜Ÿåˆ— queue ä¸Šã€‚<br />
å¦å¤– queue-&gt;rskq_accept_head ä»£è¡¨çš„æ˜¯å…¨è¿æ¥é˜Ÿåˆ—ï¼Œå®ƒæ˜¯ä¸€ä¸ªé“¾è¡¨çš„å½¢å¼ã€‚åœ¨ listen è¿™é‡Œå› ä¸ºè¿˜æ²¡æœ‰è¿æ¥ï¼Œæ‰€ä»¥å°†å…¨è¿æ¥é˜Ÿåˆ—å¤´ queue-&gt;rskq_accept_head è®¾ç½®æˆ NULLã€‚<br />
å½“å…¨è¿æ¥é˜Ÿåˆ—å’ŒåŠè¿æ¥é˜Ÿåˆ—ä¸­æœ‰å…ƒç´ çš„æ—¶å€™ï¼Œä»–ä»¬åœ¨å†…æ ¸ä¸­çš„ç»“æ„å›¾å¤§è‡´å¦‚ä¸‹ã€‚<br />
<img src="/assets/images/tcp2.png" width="500" height="500" /><br />
åœ¨æœåŠ¡å™¨ listen çš„æ—¶å€™ï¼Œä¸»è¦æ˜¯è¿›è¡Œäº†å…¨/åŠè¿æ¥é˜Ÿåˆ—çš„é•¿åº¦é™åˆ¶è®¡ç®—ï¼Œä»¥åŠç›¸å…³çš„å†…å­˜ç”³è¯·å’Œåˆå§‹åŒ–ã€‚å…¨/è¿æ¥é˜Ÿåˆ—åˆå§‹åŒ–äº†ä»¥åæ‰å¯ä»¥ç›¸åº”æ¥è‡ªå®¢æˆ·ç«¯çš„æ¡æ‰‹è¯·æ±‚ã€‚<br />
å¦‚æœæƒ³äº†è§£æ›´å¤šçš„ listen å†…éƒ¨æ“ä½œç»†èŠ‚å¯ä»¥çœ‹ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« ã€Šä¸ºä»€ä¹ˆæœåŠ¡ç«¯ç¨‹åºéƒ½éœ€è¦å…ˆ listen ä¸€ä¸‹ï¼Ÿã€‹<br />
äºŒã€å®¢æˆ·ç«¯ connect</p>

<p>å®¢æˆ·ç«¯é€šè¿‡è°ƒç”¨ connect æ¥å‘èµ·è¿æ¥ã€‚åœ¨ connect ç³»ç»Ÿè°ƒç”¨ä¸­ä¼šè¿›å…¥åˆ°å†…æ ¸æºç çš„ tcp_v4_connectã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//file: net/ipv4/tcp_ipv4.c
int tcp_v4_connect(struct sock *sk, struct sockaddr *uaddr, int addr_len)
{
 //è®¾ç½® socket çŠ¶æ€ä¸º TCP_SYN_SENT
 tcp_set_state(sk, TCP_SYN_SENT);

 //åŠ¨æ€é€‰æ‹©ä¸€ä¸ªç«¯å£
 err = inet_hash_connect(&amp;tcp_death_row, sk);

 //å‡½æ•°ç”¨æ¥æ ¹æ® sk ä¸­çš„ä¿¡æ¯ï¼Œæ„å»ºä¸€ä¸ªå®Œæˆçš„ syn æŠ¥æ–‡ï¼Œå¹¶å°†å®ƒå‘é€å‡ºå»ã€‚
 err = tcp_connect(sk);
}
</code></pre></div></div>
<p>åœ¨è¿™é‡Œå°†å®ŒæˆæŠŠ socket çŠ¶æ€è®¾ç½®ä¸º TCP_SYN_SENTã€‚å†é€šè¿‡ inet_hash_connect æ¥åŠ¨æ€åœ°é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„ç«¯å£åï¼ˆç«¯å£é€‰æ‹©è¯¦ç»†è¿‡ç¨‹å‚è€ƒå‰æ–‡ã€ŠTCPè¿æ¥ä¸­å®¢æˆ·ç«¯çš„ç«¯å£å·æ˜¯å¦‚ä½•ç¡®å®šçš„ï¼Ÿã€‹ï¼‰ï¼Œè¿›å…¥åˆ° tcp_connect ä¸­ã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//file:net/ipv4/tcp_output.c
int tcp_connect(struct sock *sk)
{
 tcp_connect_init(sk);

 //ç”³è¯· skb å¹¶æ„é€ ä¸ºä¸€ä¸ª SYN åŒ…
 ......

 //æ·»åŠ åˆ°å‘é€é˜Ÿåˆ— sk_write_queue ä¸Š
 tcp_connect_queue_skb(sk, buff);

 //å®é™…å‘å‡º syn
 err = tp-&gt;fastopen_req ? tcp_send_syn_data(sk, buff) :
    tcp_transmit_skb(sk, buff, 1, sk-&gt;sk_allocation);

 //å¯åŠ¨é‡ä¼ å®šæ—¶å™¨
 inet_csk_reset_xmit_timer(sk, ICSK_TIME_RETRANS,
      inet_csk(sk)-&gt;icsk_rto, TCP_RTO_MAX);
}
</code></pre></div></div>
<p>åœ¨ tcp_connect ç”³è¯·å’Œæ„é€  SYN åŒ…ï¼Œç„¶åå°†å…¶å‘å‡ºã€‚åŒæ—¶è¿˜å¯åŠ¨äº†ä¸€ä¸ªé‡ä¼ å®šæ—¶å™¨ï¼Œè¯¥å®šæ—¶å™¨çš„ä½œç”¨æ˜¯ç­‰åˆ°ä¸€å®šæ—¶é—´åæ”¶ä¸åˆ°æœåŠ¡å™¨çš„åé¦ˆçš„æ—¶å€™æ¥å¼€å¯é‡ä¼ ã€‚åœ¨ 3.10 ç‰ˆæœ¬ä¸­é¦–æ¬¡è¶…æ—¶æ—¶é—´æ˜¯ 1 sï¼Œä¸€äº›è€ç‰ˆæœ¬ä¸­æ˜¯ 3 sã€‚<br />
æ€»ç»“ä¸€ä¸‹ï¼Œå®¢æˆ·ç«¯åœ¨ connect çš„æ—¶å€™ï¼ŒæŠŠæœ¬åœ° socket çŠ¶æ€è®¾ç½®æˆäº† TCP_SYN_SENTï¼Œé€‰äº†ä¸€ä¸ªå¯ç”¨çš„ç«¯å£ï¼Œæ¥ç€å‘å‡º SYN æ¡æ‰‹è¯·æ±‚å¹¶å¯åŠ¨é‡ä¼ å®šæ—¶å™¨ã€‚<br />
ä¸‰ã€æœåŠ¡å™¨å“åº” SYN</p>

<p>åœ¨æœåŠ¡å™¨ç«¯ï¼Œæ‰€æœ‰çš„ TCP åŒ…ï¼ˆåŒ…æ‹¬å®¢æˆ·ç«¯å‘æ¥çš„ SYN æ¡æ‰‹è¯·æ±‚ï¼‰éƒ½ç»è¿‡ç½‘å¡ã€è½¯ä¸­æ–­ï¼Œè¿›å…¥åˆ° tcp_v4_rcvã€‚åœ¨è¯¥å‡½æ•°ä¸­æ ¹æ®ç½‘ç»œåŒ…ï¼ˆskbï¼‰TCP å¤´ä¿¡æ¯ä¸­çš„ç›®çš„ IP ä¿¡æ¯æŸ¥åˆ°å½“å‰åœ¨ listen çš„ socketã€‚ç„¶åç»§ç»­è¿›å…¥ tcp_v4_do_rcv å¤„ç†æ¡æ‰‹è¿‡ç¨‹ã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//file: net/ipv4/tcp_ipv4.c
int tcp_v4_do_rcv(struct sock *sk, struct sk_buff *skb)
{
 ...
 //æœåŠ¡å™¨æ”¶åˆ°ç¬¬ä¸€æ­¥æ¡æ‰‹ SYN æˆ–è€…ç¬¬ä¸‰æ­¥ ACK éƒ½ä¼šèµ°åˆ°è¿™é‡Œ
 if (sk-&gt;sk_state == TCP_LISTEN) {
  struct sock *nsk = tcp_v4_hnd_req(sk, skb);
 }

 if (tcp_rcv_state_process(sk, skb, tcp_hdr(skb), skb-&gt;len)) {
  rsk = sk;
  goto reset;
 }
}
</code></pre></div></div>
<p>åœ¨ tcp_v4_do_rcv ä¸­åˆ¤æ–­å½“å‰ socket æ˜¯ listen çŠ¶æ€åï¼Œé¦–å…ˆä¼šåˆ° tcp_v4_hnd_req å»æŸ¥çœ‹åŠè¿æ¥é˜Ÿåˆ—ã€‚æœåŠ¡å™¨ç¬¬ä¸€æ¬¡å“åº” SYN çš„æ—¶å€™ï¼ŒåŠè¿æ¥é˜Ÿåˆ—é‡Œå¿…ç„¶æ˜¯ç©ºç©ºå¦‚ä¹Ÿï¼Œæ‰€ä»¥ç›¸å½“äºä»€ä¹ˆä¹Ÿæ²¡å¹²å°±è¿”å›äº†ã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//file:net/ipv4/tcp_ipv4.c
static struct sock *tcp_v4_hnd_req(struct sock *sk, struct sk_buff *skb)
{
 // æŸ¥æ‰¾ listen socket çš„åŠè¿æ¥é˜Ÿåˆ—
 struct request_sock *req = inet_csk_search_req(sk, &amp;prev, th-&gt;source,
          iph-&gt;saddr, iph-&gt;daddr);
 ...
 return sk;
}
</code></pre></div></div>
<p>åœ¨ tcp_rcv_state_process é‡Œæ ¹æ®ä¸åŒçš„ socket çŠ¶æ€è¿›è¡Œä¸åŒçš„å¤„ç†ã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//file:net/ipv4/tcp_input.c
int tcp_rcv_state_process(struct sock *sk, struct sk_buff *skb,
     const struct tcphdr *th, unsigned int len)
{
 switch (sk-&gt;sk_state) {
  //ç¬¬ä¸€æ¬¡æ¡æ‰‹
  case TCP_LISTEN:
   if (th-&gt;syn) { //åˆ¤æ–­æ˜¯ SYN æ¡æ‰‹åŒ…
    ...
    if (icsk-&gt;icsk_af_ops-&gt;conn_request(sk, skb) &lt; 0)
     return 1;
 ......
}  
</code></pre></div></div>
<p>å…¶ä¸­ conn_request æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘ tcp_v4_conn_requestã€‚æœåŠ¡å™¨å“åº” SYN çš„ä¸»è¦å¤„ç†é€»è¾‘éƒ½åœ¨è¿™ä¸ª tcp_v4_conn_request é‡Œã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//file: net/ipv4/tcp_ipv4.c
int tcp_v4_conn_request(struct sock *sk, struct sk_buff *skb)
{
 //çœ‹çœ‹åŠè¿æ¥é˜Ÿåˆ—æ˜¯å¦æ»¡äº†
 if (inet_csk_reqsk_queue_is_full(sk) &amp;&amp; !isn) {
  want_cookie = tcp_syn_flood_action(sk, skb, "TCP");
  if (!want_cookie)
   goto drop;
 }

 //åœ¨å…¨è¿æ¥é˜Ÿåˆ—æ»¡çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæœ‰ young_ackï¼Œé‚£ä¹ˆç›´æ¥ä¸¢
 if (sk_acceptq_is_full(sk) &amp;&amp; inet_csk_reqsk_queue_young(sk) &gt; 1) {
  NET_INC_STATS_BH(sock_net(sk), LINUX_MIB_LISTENOVERFLOWS);
  goto drop;
 }
 ...
 //åˆ†é… request_sock å†…æ ¸å¯¹è±¡
 req = inet_reqsk_alloc(&amp;tcp_request_sock_ops);

 //æ„é€  syn+ack åŒ…
 skb_synack = tcp_make_synack(sk, dst, req,
  fastopen_cookie_present(&amp;valid_foc) ? &amp;valid_foc : NULL);

 if (likely(!do_fastopen)) {
  //å‘é€ syn + ack å“åº”
  err = ip_build_and_send_pkt(skb_synack, sk, ireq-&gt;loc_addr,
    ireq-&gt;rmt_addr, ireq-&gt;opt);

  //æ·»åŠ åˆ°åŠè¿æ¥é˜Ÿåˆ—ï¼Œå¹¶å¼€å¯è®¡æ—¶å™¨
  inet_csk_reqsk_queue_hash_add(sk, req, TCP_TIMEOUT_INIT);
 }else ...
}
</code></pre></div></div>
<p>åœ¨è¿™é‡Œé¦–å…ˆåˆ¤æ–­åŠè¿æ¥é˜Ÿåˆ—æ˜¯å¦æ»¡äº†ï¼Œå¦‚æœæ»¡äº†çš„è¯è¿›å…¥ tcp_syn_flood_action å»åˆ¤æ–­æ˜¯å¦å¼€å¯äº† tcp_syncookies å†…æ ¸å‚æ•°ã€‚å¦‚æœé˜Ÿåˆ—æ»¡ï¼Œä¸”æœªå¼€å¯ tcp_syncookiesï¼Œé‚£ä¹ˆè¯¥æ¡æ‰‹åŒ…å°†ç›´æ¥è¢«ä¸¢å¼ƒï¼ï¼<br />
æ¥ç€è¿˜è¦åˆ¤æ–­å…¨è¿æ¥é˜Ÿåˆ—æ˜¯å¦æ»¡ã€‚å› ä¸ºå…¨è¿æ¥é˜Ÿåˆ—æ»¡ä¹Ÿä¼šå¯¼è‡´æ¡æ‰‹å¼‚å¸¸çš„ï¼Œé‚£å¹²è„†å°±åœ¨ç¬¬ä¸€æ¬¡æ¡æ‰‹çš„æ—¶å€™ä¹Ÿåˆ¤æ–­äº†ã€‚å¦‚æœå…¨è¿æ¥é˜Ÿåˆ—æ»¡äº†ï¼Œä¸”æœ‰ young_ack çš„è¯ï¼Œé‚£ä¹ˆåŒæ ·ä¹Ÿæ˜¯ç›´æ¥ä¸¢å¼ƒã€‚<br />
young_ack æ˜¯åŠè¿æ¥é˜Ÿåˆ—é‡Œä¿æŒç€çš„ä¸€ä¸ªè®¡æ•°å™¨ã€‚è®°å½•çš„æ˜¯åˆšæœ‰SYNåˆ°è¾¾ï¼Œæ²¡æœ‰è¢«SYN_ACKé‡ä¼ å®šæ—¶å™¨é‡ä¼ è¿‡SYN_ACKï¼ŒåŒæ—¶ä¹Ÿæ²¡æœ‰å®Œæˆè¿‡ä¸‰æ¬¡æ¡æ‰‹çš„sockæ•°é‡<br />
æ¥ä¸‹æ¥æ˜¯æ„é€  synack åŒ…ï¼Œç„¶åé€šè¿‡ ip_build_and_send_pkt æŠŠå®ƒå‘é€å‡ºå»ã€‚<br />
æœ€åæŠŠå½“å‰æ¡æ‰‹ä¿¡æ¯æ·»åŠ åˆ°åŠè¿æ¥é˜Ÿåˆ—ï¼Œå¹¶å¼€å¯è®¡æ—¶å™¨ã€‚è®¡æ—¶å™¨çš„ä½œç”¨æ˜¯å¦‚æœæŸä¸ªæ—¶é—´ä¹‹å†…è¿˜æ”¶ä¸åˆ°å®¢æˆ·ç«¯çš„ç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„è¯ï¼ŒæœåŠ¡å™¨ä¼šé‡ä¼  synack åŒ…ã€‚<br />
æ€»ç»“ä¸€ä¸‹ï¼ŒæœåŠ¡å™¨å“åº” ack æ˜¯ä¸»è¦å·¥ä½œæ˜¯åˆ¤æ–­ä¸‹æ¥æ”¶é˜Ÿåˆ—æ˜¯å¦æ»¡äº†ï¼Œæ»¡çš„è¯å¯èƒ½ä¼šä¸¢å¼ƒè¯¥è¯·æ±‚ï¼Œå¦åˆ™å‘å‡º synackã€‚ç”³è¯· request_sock æ·»åŠ åˆ°åŠè¿æ¥é˜Ÿåˆ—ä¸­ï¼ŒåŒæ—¶å¯åŠ¨å®šæ—¶å™¨ã€‚<br />
å››ã€å®¢æˆ·ç«¯å“åº” SYNACK</p>

<p>å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨ç«¯å‘æ¥çš„ synack åŒ…çš„æ—¶å€™ï¼Œä¹Ÿä¼šè¿›å…¥åˆ° tcp_rcv_state_process å‡½æ•°ä¸­æ¥ã€‚ä¸è¿‡ç”±äºè‡ªèº« socket çš„çŠ¶æ€æ˜¯ TCP_SYN_SENTï¼Œæ‰€ä»¥ä¼šè¿›å…¥åˆ°å¦ä¸€ä¸ªä¸åŒçš„åˆ†æ”¯ä¸­å»ã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//file:net/ipv4/tcp_input.c
//é™¤äº† ESTABLISHED å’Œ TIME_WAITï¼Œå…¶ä»–çŠ¶æ€ä¸‹çš„ TCP å¤„ç†éƒ½èµ°è¿™é‡Œ
int tcp_rcv_state_process(struct sock *sk, struct sk_buff *skb,
     const struct tcphdr *th, unsigned int len)
{
 switch (sk-&gt;sk_state) {
  //æœåŠ¡å™¨æ”¶åˆ°ç¬¬ä¸€ä¸ªACKåŒ…
  case TCP_LISTEN:
   ...
  //å®¢æˆ·ç«¯ç¬¬äºŒæ¬¡æ¡æ‰‹å¤„ç† 
  case TCP_SYN_SENT:
   //å¤„ç† synack åŒ…
   queued = tcp_rcv_synsent_state_process(sk, skb, th, len);
   ...
   return 0;
}
</code></pre></div></div>
<p>tcp_rcv_synsent_state_process æ˜¯å®¢æˆ·ç«¯å“åº” synack çš„ä¸»è¦é€»è¾‘ã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//file:net/ipv4/tcp_input.c
static int tcp_rcv_synsent_state_process(struct sock *sk, struct sk_buff *skb,
      const struct tcphdr *th, unsigned int len)
{
 ...

 tcp_ack(sk, skb, FLAG_SLOWPATH);

 //è¿æ¥å»ºç«‹å®Œæˆ 
 tcp_finish_connect(sk, skb);

 if (sk-&gt;sk_write_pending ||
   icsk-&gt;icsk_accept_queue.rskq_defer_accept ||
   icsk-&gt;icsk_ack.pingpong)
  //å»¶è¿Ÿç¡®è®¤...
 else {
  tcp_send_ack(sk);
 }
} 
tcp_ack()-&gt;tcp_clean_rtx_queue()
//file: net/ipv4/tcp_input.c
static int tcp_clean_rtx_queue(struct sock *sk, int prior_fackets,
       u32 prior_snd_una)
{
 //åˆ é™¤å‘é€é˜Ÿåˆ—
 ...

 //åˆ é™¤å®šæ—¶å™¨
 tcp_rearm_rto(sk);
}
//file: net/ipv4/tcp_input.c
void tcp_finish_connect(struct sock *sk, struct sk_buff *skb)
{
 //ä¿®æ”¹ socket çŠ¶æ€
 tcp_set_state(sk, TCP_ESTABLISHED);

 //åˆå§‹åŒ–æ‹¥å¡æ§åˆ¶
 tcp_init_congestion_control(sk);
 ...

 //ä¿æ´»è®¡æ—¶å™¨æ‰“å¼€
 if (sock_flag(sk, SOCK_KEEPOPEN))
  inet_csk_reset_keepalive_timer(sk, keepalive_time_when(tp));
}
</code></pre></div></div>
<p>å®¢æˆ·ç«¯ä¿®æ”¹è‡ªå·±çš„ socket çŠ¶æ€ä¸º ESTABLISHEDï¼Œæ¥ç€æ‰“å¼€ TCP çš„ä¿æ´»è®¡æ—¶å™¨ã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//file:net/ipv4/tcp_output.c
void tcp_send_ack(struct sock *sk)
{
 //ç”³è¯·å’Œæ„é€  ack åŒ…
 buff = alloc_skb(MAX_TCP_HEADER, sk_gfp_atomic(sk, GFP_ATOMIC));
 ...

 //å‘é€å‡ºå»
 tcp_transmit_skb(sk, buff, 0, sk_gfp_atomic(sk, GFP_ATOMIC));
}
</code></pre></div></div>
<p>åœ¨ tcp_send_ack ä¸­æ„é€  ack åŒ…ï¼Œå¹¶æŠŠå®ƒå‘é€äº†å‡ºå»ã€‚<br />
å®¢æˆ·ç«¯å“åº”æ¥è‡ªæœåŠ¡å™¨ç«¯çš„ synack æ—¶æ¸…é™¤äº† connect æ—¶è®¾ç½®çš„é‡ä¼ å®šæ—¶å™¨ï¼ŒæŠŠå½“å‰ socket çŠ¶æ€è®¾ç½®ä¸º ESTABLISHEDï¼Œå¼€å¯ä¿æ´»è®¡æ—¶å™¨åå‘å‡ºç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„ ack ç¡®è®¤ã€‚<br />
äº”ã€æœåŠ¡å™¨å“åº” ACK</p>

<p>æœåŠ¡å™¨å“åº”ç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„ ack æ—¶åŒæ ·ä¼šè¿›å…¥åˆ° tcp_v4_do_rcv</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//file: net/ipv4/tcp_ipv4.c
int tcp_v4_do_rcv(struct sock *sk, struct sk_buff *skb)
{
 ...
 if (sk-&gt;sk_state == TCP_LISTEN) {
  struct sock *nsk = tcp_v4_hnd_req(sk, skb);
 }

 if (tcp_rcv_state_process(sk, skb, tcp_hdr(skb), skb-&gt;len)) {
  rsk = sk;
  goto reset;
 }
}
</code></pre></div></div>
<p>ä¸è¿‡ç”±äºè¿™å·²ç»æ˜¯ç¬¬ä¸‰æ¬¡æ¡æ‰‹äº†ï¼ŒåŠè¿æ¥é˜Ÿåˆ—é‡Œä¼šå­˜åœ¨ä¸Šæ¬¡ç¬¬ä¸€æ¬¡æ¡æ‰‹æ—¶ç•™ä¸‹çš„åŠè¿æ¥ä¿¡æ¯ã€‚æ‰€ä»¥ tcp_v4_hnd_req çš„æ‰§è¡Œé€»è¾‘ä¼šä¸å¤ªä¸€æ ·ã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//file:net/ipv4/tcp_ipv4.c
static struct sock *tcp_v4_hnd_req(struct sock *sk, struct sk_buff *skb)
{
 ...
 struct request_sock *req = inet_csk_search_req(sk, &amp;prev, th-&gt;source,
          iph-&gt;saddr, iph-&gt;daddr);
 if (req)
  return tcp_check_req(sk, skb, req, prev, false);
 ...
}
</code></pre></div></div>
<p>inet_csk_search_req è´Ÿè´£åœ¨åŠè¿æ¥é˜Ÿåˆ—é‡Œè¿›è¡ŒæŸ¥æ‰¾ï¼Œæ‰¾åˆ°ä»¥åè¿”å›ä¸€ä¸ªåŠè¿æ¥ request_sock å¯¹è±¡ã€‚ç„¶åè¿›å…¥åˆ° tcp_check_req ä¸­ã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//fileï¼šnet/ipv4/tcp_minisocks.c
struct sock *tcp_check_req(struct sock *sk, struct sk_buff *skb,
      struct request_sock *req,
      struct request_sock **prev,
      bool fastopen)
{
 ...
 //åˆ›å»ºå­ socket
 child = inet_csk(sk)-&gt;icsk_af_ops-&gt;syn_recv_sock(sk, skb, req, NULL);
 ...

 //æ¸…ç†åŠè¿æ¥é˜Ÿåˆ—
 inet_csk_reqsk_queue_unlink(sk, req, prev);
 inet_csk_reqsk_queue_removed(sk, req);

 //æ·»åŠ å…¨è¿æ¥é˜Ÿåˆ—
 inet_csk_reqsk_queue_add(sk, req, child);
 return child;
}
</code></pre></div></div>
<p>5.1 åˆ›å»ºå­ socket</p>

<p>icsk_af_ops-&gt;syn_recv_sock å¯¹åº”çš„æ˜¯ tcp_v4_syn_recv_sock å‡½æ•°ã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//file:net/ipv4/tcp_ipv4.c
const struct inet_connection_sock_af_ops ipv4_specific = {
 ......
 .conn_request      = tcp_v4_conn_request,
 .syn_recv_sock     = tcp_v4_syn_recv_sock,

//ä¸‰æ¬¡æ¡æ‰‹æ¥è¿‘å°±ç®—æ˜¯å®Œæ¯•äº†ï¼Œè¿™é‡Œåˆ›å»º sock å†…æ ¸å¯¹è±¡
struct sock *tcp_v4_syn_recv_sock(struct sock *sk, struct sk_buff *skb,
      struct request_sock *req,
      struct dst_entry *dst)
{    
 //åˆ¤æ–­æ¥æ”¶é˜Ÿåˆ—æ˜¯ä¸æ˜¯æ»¡äº†
 if (sk_acceptq_is_full(sk))
  goto exit_overflow;

 //åˆ›å»º sock &amp;&amp; åˆå§‹åŒ–
 newsk = tcp_create_openreq_child(sk, req, skb);
</code></pre></div></div>
<p><strong>æ³¨æ„ï¼Œåœ¨ç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„è¿™é‡Œåˆç»§ç»­åˆ¤æ–­ä¸€æ¬¡å…¨è¿æ¥é˜Ÿåˆ—æ˜¯å¦æ»¡äº†ï¼Œå¦‚æœæ»¡äº†ä¿®æ”¹ä¸€ä¸‹è®¡æ•°å™¨å°±ä¸¢å¼ƒäº†ã€‚</strong>å¦‚æœé˜Ÿåˆ—ä¸æ»¡ï¼Œé‚£ä¹ˆå°±ç”³è¯·åˆ›å»ºæ–°çš„ sock å¯¹è±¡ã€‚<br />
5.2 åˆ é™¤åŠè¿æ¥é˜Ÿåˆ—</p>

<p>æŠŠè¿æ¥è¯·æ±‚å—ä»åŠè¿æ¥é˜Ÿåˆ—ä¸­åˆ é™¤ã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//file: include/net/inet_connection_sock.h 
static inline void inet_csk_reqsk_queue_unlink(struct sock *sk, struct request_sock *req,
 struct request_sock **prev)
{
 reqsk_queue_unlink(&amp;inet_csk(sk)-&gt;icsk_accept_queue, req, prev);
}
</code></pre></div></div>
<p>reqsk_queue_unlink ä¸­æŠŠè¿æ¥è¯·æ±‚å—ä»åŠè¿æ¥é˜Ÿåˆ—ä¸­åˆ é™¤ã€‚<br />
5.3 æ·»åŠ å…¨è¿æ¥é˜Ÿåˆ—</p>

<p>æ¥ç€æ·»åŠ åˆ°å…¨è¿æ¥é˜Ÿåˆ—é‡Œè¾¹æ¥ã€‚
//file:net/ipv4/syncookies.c
static inline void inet_csk_reqsk_queue_add(struct sock *sk,
      struct request_sock *req,
      struct sock *child)
{
 reqsk_queue_add(&amp;inet_csk(sk)-&gt;icsk_accept_queue, req, sk, child);
}
åœ¨ reqsk_queue_add ä¸­å°†æ¡æ‰‹æˆåŠŸçš„ request_sock å¯¹è±¡æ’å…¥åˆ°å…¨è¿æ¥é˜Ÿåˆ—é“¾è¡¨çš„å°¾éƒ¨ã€‚
//file: include/net/request_sock.h
static inline void reqsk_queue_add(â€¦)
{
 req-&gt;sk = child;
 sk_acceptq_added(parent);</p>

<p>if (queue-&gt;rskq_accept_head == NULL)
  queue-&gt;rskq_accept_head = req;
 else
  queue-&gt;rskq_accept_tail-&gt;dl_next = req;</p>

<p>queue-&gt;rskq_accept_tail = req;
 req-&gt;dl_next = NULL;
}
5.4 è®¾ç½®è¿æ¥ä¸º ESTABLISHED</p>

<p>//file:net/ipv4/tcp_input.c
int tcp_rcv_state_process(struct sock *sk, struct sk_buff *skb,
     const struct tcphdr *th, unsigned int len)
{
 â€¦
 switch (sk-&gt;sk_state) {</p>

<p>//æœåŠ¡ç«¯ç¬¬ä¸‰æ¬¡æ¡æ‰‹å¤„ç†
  case TCP_SYN_RECV:</p>

<p>//æ”¹å˜çŠ¶æ€ä¸ºè¿æ¥
   tcp_set_state(sk, TCP_ESTABLISHED);
   â€¦
 }
}
å°†è¿æ¥è®¾ç½®ä¸º TCP_ESTABLISHED çŠ¶æ€ã€‚
æœåŠ¡å™¨å“åº”ç¬¬ä¸‰æ¬¡æ¡æ‰‹ ack æ‰€åšçš„å·¥ä½œæ˜¯æŠŠå½“å‰åŠè¿æ¥å¯¹è±¡åˆ é™¤ï¼Œåˆ›å»ºäº†æ–°çš„ sock ååŠ å…¥åˆ°å…¨è¿æ¥é˜Ÿåˆ—ä¸­ï¼Œæœ€åå°†æ–°è¿æ¥çŠ¶æ€è®¾ç½®ä¸º ESTABLISHEDã€‚
å…­ã€æœåŠ¡å™¨ accept</p>

<p>æœ€å accept ä¸€æ­¥å’±ä»¬é•¿è¯çŸ­è¯´ã€‚
//file: net/ipv4/inet_connection_sock.c
struct sock *inet_csk_accept(struct sock *sk, int flags, int *err)
{
 //ä»å…¨è¿æ¥é˜Ÿåˆ—ä¸­è·å–
 struct request_sock_queue *queue = &amp;icsk-&gt;icsk_accept_queue;
 req = reqsk_queue_remove(queue);</p>

<p>newsk = req-&gt;sk;
 return newsk;
}
reqsk_queue_remove è¿™ä¸ªæ“ä½œå¾ˆç®€å•ï¼Œå°±æ˜¯ä»å…¨è¿æ¥é˜Ÿåˆ—çš„é“¾è¡¨é‡Œè·å–å‡ºç¬¬ä¸€ä¸ªå…ƒç´ è¿”å›å°±è¡Œäº†ã€‚
//file:include/net/request_sock.h
static inline struct request_sock *reqsk_queue_remove(struct request_sock_queue *queue)
{
 struct request_sock *req = queue-&gt;rskq_accept_head;</p>

<p>queue-&gt;rskq_accept_head = req-&gt;dl_next;
 if (queue-&gt;rskq_accept_head == NULL)
  queue-&gt;rskq_accept_tail = NULL;</p>

<p>return req;
}
æ‰€ä»¥ï¼Œaccept çš„é‡ç‚¹å·¥ä½œå°±æ˜¯ä»å·²ç»å»ºç«‹å¥½çš„å…¨è¿æ¥é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªè¿”å›ç»™ç”¨æˆ·è¿›ç¨‹ã€‚
æœ¬æ–‡æ€»ç»“</p>

<p>åœ¨åç«¯ç›¸å…³å²—ä½çš„å…¥èŒé¢è¯•ä¸­ï¼Œä¸‰æ¬¡æ¡æ‰‹çš„å‡ºåœºé¢‘ç‡éå¸¸çš„é«˜ã€‚å…¶å®åœ¨ä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹ä¸­ï¼Œä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ¡æ‰‹åŒ…çš„å‘é€ å’Œ TCP çŠ¶æ€çš„æµè½¬ã€‚è¿˜åŒ…å«äº†ç«¯å£é€‰æ‹©ï¼Œè¿æ¥é˜Ÿåˆ—åˆ›å»ºä¸å¤„ç†ç­‰å¾ˆå¤šå…³é”®æŠ€æœ¯ç‚¹ã€‚é€šè¿‡ä»Šå¤©ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬æ·±åº¦å»äº†è§£äº†ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ä¸­å†…æ ¸ä¸­çš„è¿™äº›å†…éƒ¨æ“ä½œã€‚
å…¨æ–‡æ´‹æ´‹æ´’æ´’ä¸Šä¸‡å­—å­—ï¼Œå…¶å®å¯ä»¥ç”¨ä¸€å¹…å›¾æ€»ç»“èµ·æ¥ã€‚
å›¾ç‰‡</p>

<ol>
  <li>æœåŠ¡å™¨ listen æ—¶ï¼Œè®¡ç®—äº†å…¨/åŠè¿æ¥é˜Ÿåˆ—çš„é•¿åº¦ï¼Œè¿˜ç”³è¯·äº†ç›¸å…³å†…å­˜å¹¶åˆå§‹åŒ–ã€‚</li>
  <li>å®¢æˆ·ç«¯ connect æ—¶ï¼ŒæŠŠæœ¬åœ° socket çŠ¶æ€è®¾ç½®æˆäº† TCP_SYN_SENTï¼Œé€‰åˆ™ä¸€ä¸ªå¯ç”¨çš„ç«¯å£ï¼Œå‘å‡º SYN æ¡æ‰‹è¯·æ±‚å¹¶å¯åŠ¨é‡ä¼ å®šæ—¶å™¨ã€‚</li>
  <li>æœåŠ¡å™¨å“åº” ack æ—¶ï¼Œä¼šåˆ¤æ–­ä¸‹æ¥æ”¶é˜Ÿåˆ—æ˜¯å¦æ»¡äº†ï¼Œæ»¡çš„è¯å¯èƒ½ä¼šä¸¢å¼ƒè¯¥è¯·æ±‚ã€‚å¦åˆ™å‘å‡º synackï¼Œç”³è¯· request_sock æ·»åŠ åˆ°åŠè¿æ¥é˜Ÿåˆ—ä¸­ï¼ŒåŒæ—¶å¯åŠ¨å®šæ—¶å™¨ã€‚</li>
  <li>å®¢æˆ·ç«¯å“åº” synack æ—¶ï¼Œæ¸…é™¤äº† connect æ—¶è®¾ç½®çš„é‡ä¼ å®šæ—¶å™¨ï¼ŒæŠŠå½“å‰ socket çŠ¶æ€è®¾ç½®ä¸º ESTABLISHEDï¼Œå¼€å¯ä¿æ´»è®¡æ—¶å™¨åå‘å‡ºç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„ ack ç¡®è®¤ã€‚</li>
  <li>æœåŠ¡å™¨å“åº” ack æ—¶ï¼ŒæŠŠå¯¹åº”åŠè¿æ¥å¯¹è±¡åˆ é™¤ï¼Œåˆ›å»ºäº†æ–°çš„ sock ååŠ å…¥åˆ°å…¨è¿æ¥é˜Ÿåˆ—ä¸­ï¼Œæœ€åå°†æ–°è¿æ¥çŠ¶æ€è®¾ç½®ä¸º ESTABLISHEDã€‚</li>
  <li>accept ä»å·²ç»å»ºç«‹å¥½çš„å…¨è¿æ¥é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªè¿”å›ç»™ç”¨æˆ·è¿›ç¨‹ã€‚
å¦å¤–è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ¡æ‰‹è¿‡ç¨‹ä¸­å‘ç”Ÿä¸¢åŒ…ï¼ˆç½‘ç»œé—®é¢˜ï¼Œæˆ–è€…æ˜¯è¿æ¥é˜Ÿåˆ—æº¢å‡ºï¼‰ï¼Œå†…æ ¸ä¼šç­‰å¾…å®šæ—¶å™¨åˆ°æœŸåé‡è¯•ï¼Œé‡è¯•æ—¶é—´é—´éš”åœ¨ 3.10 ç‰ˆæœ¬é‡Œåˆ†åˆ«æ˜¯ 1s 2s 4s â€¦ã€‚åœ¨ä¸€äº›è€ç‰ˆæœ¬é‡Œï¼Œæ¯”å¦‚ 2.6 é‡Œï¼Œç¬¬ä¸€æ¬¡é‡è¯•æ—¶é—´æ˜¯ 3 ç§’ã€‚æœ€å¤§é‡è¯•æ¬¡æ•°åˆ†åˆ«ç”± tcp_syn_retries å’Œ tcp_synack_retries æ§åˆ¶ã€‚
å¦‚æœä½ çš„çº¿ä¸Šæ¥å£æ­£å¸¸éƒ½æ˜¯å‡ åæ¯«ç§’å†…è¿”å›ï¼Œä½†å¶å°”å‡ºç°äº† 1 sã€æˆ–è€… 3 s ç­‰è¿™ç§å¶å‘çš„å“åº”è€—æ—¶å˜é•¿çš„é—®é¢˜ï¼Œé‚£ä¹ˆä½ å°±è¦å»å®šä½ä¸€ä¸‹çœ‹çœ‹æ˜¯ä¸æ˜¯å‡ºç°äº†æ¡æ‰‹åŒ…çš„è¶…æ—¶é‡ä¼ äº†ã€‚
ä»¥ä¸Šå°±æ˜¯ä¸‰æ¬¡æ¡æ‰‹ä¸­ä¸€äº›æ›´è¯¦ç»†çš„å†…éƒ¨æ“ä½œã€‚å¦‚æœä½ èƒ½åœ¨é¢è¯•å®˜é¢å‰è®²å‡ºæ¥å†…æ ¸çš„è¿™äº›åº•å±‚é€»è¾‘ï¼Œæˆ‘ç›¸ä¿¡é¢è¯•å®˜ä¸€å®šä¼šå¯¹ä½ åˆ®ç›®ç›¸çœ‹çš„ï¼</li>
</ol>

:ET